{% extends "base.html" %}

{% block title %}Login - Nexus Digital Bank{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow fade-in">
            <div class="card-header bg-primary text-white text-center">
                <h3><i class="fas fa-shield-alt me-2"></i>Secure Login</h3>
                <p class="mb-0">Access Your Nexus Digital Bank Account</p>
            </div>
            <div class="card-body">

                <form method="POST" id="loginForm">
                    {% if show_lockout %}
                    <!-- Account Lockout Screen -->
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Account Temporarily Locked</strong>
                        <p class="mb-0 mt-2">
                            Your account has been temporarily locked due to suspicious activity. 
                            Multiple invalid security codes were detected.
                        </p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        <strong>Lockout Time Remaining:</strong>
                        <div class="mt-2">
                            <h4 class="text-center" id="lockoutCountdown">Loading...</h4>
                            <div class="progress">
                                <div class="progress-bar bg-warning" role="progressbar" id="lockoutProgress" 
                                     style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Security Notice:</strong>
                        <ul class="mb-0 mt-2">
                            <li>This lockout protects your account from unauthorized access</li>
                            <li>Please wait for the lockout period to expire</li>
                            <li>If you believe this is an error, contact customer service</li>
                            <li>Call: <strong>1-800-NEXUS-1</strong></li>
                        </ul>
                    </div>
                    
                    <button type="button" class="btn btn-secondary w-100" disabled id="lockedBtn">
                        <i class="fas fa-lock me-2"></i>
                        <span>Account Locked - Please Wait</span>
                    </button>
                    
                    <div class="mt-3 text-center">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshLockoutStatus()">
                            <i class="fas fa-sync-alt me-1"></i>Check Status
                        </button>
                    </div>
                    
                    {% elif not show_2fa %}
                    <!-- Initial Login Form -->
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="fas fa-user me-2"></i>Username or Account Number
                        </label>
                        <input type="text" class="form-control" id="username" name="username" 
                               value="{{ username if show_2fa else '' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-key me-2"></i>Password
                        </label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="remember">
                        <label class="form-check-label" for="remember">
                            Remember this device
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        <span id="loginText">Sign In</span>
                        <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                    
                    {% else %}
                    <!-- 2FA Verification Form -->
                    <div class="alert alert-warning">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Two-Factor Authentication Required</strong>
                        <p class="mb-0 mt-2">
                            Enter the 6-digit verification code 
                            {% if method == 'sms' %}
                                sent to your mobile device via SMS.
                            {% elif method == 'email' %}
                                sent to your registered email address.
                            {% elif method == 'app' %}
                                from your authenticator app.
                            {% else %}
                                sent to your registered device.
                            {% endif %}
                        </p>
                    </div>
                    
                    <input type="hidden" name="username" value="{{ username }}">
                    <input type="hidden" name="password" value="verified">
                    
                    <div class="mb-3">
                        <label for="two_fa_code" class="form-label">
                            {% if method == 'sms' %}
                                <i class="fas fa-mobile-alt me-2"></i>SMS Verification Code
                            {% elif method == 'email' %}
                                <i class="fas fa-envelope me-2"></i>Email Verification Code
                            {% elif method == 'app' %}
                                <i class="fas fa-qrcode me-2"></i>Authenticator Code
                            {% else %}
                                <i class="fas fa-mobile-alt me-2"></i>Verification Code
                            {% endif %}
                        </label>
                        <input type="text" class="form-control text-center" id="two_fa_code" name="two_fa_code" 
                               maxlength="6" pattern="[0-9]{6}" placeholder="000000" required 
                               style="font-size: 1.5rem; letter-spacing: 0.5rem;">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            {% if method == 'sms' %}
                                Code sent via SMS to your registered phone number
                            {% elif method == 'email' %}
                                Code sent to your registered email address
                            {% elif method == 'app' %}
                                Open your authenticator app to get the current code
                            {% else %}
                                Code sent to your registered device
                            {% endif %}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100" id="verifyBtn">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="verifyText">Verify & Login</span>
                        <span id="verifySpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                    
                    <div class="mt-3 text-center">
                        <a href="{{ url_for('login') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Login
                        </a>
                        <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="resend2FA()">
                            <i class="fas fa-redo me-1"></i>Resend Code
                        </button>
                    </div>
                    {% endif %}
                </form>
                
                <hr>
                
                <div class="text-center">
                    <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#forgotModal">
                        <i class="fas fa-question-circle me-1"></i>Forgot Password?
                    </a>
                    <br><br>
                    <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#enrollModal">
                        <i class="fas fa-user-plus me-1"></i>Enroll in Online Banking
                    </a>
                </div>
            </div>
            <div class="card-footer text-center text-muted">
                <small>
                    <i class="fas fa-shield-alt me-1"></i>
                    Your connection is secured with 256-bit SSL encryption
                </small>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="text-center"><i class="fas fa-phone me-2"></i>Need Help?</h5>
                <p class="text-center">
                    Call our 24/7 customer support at <strong>1-800-NEXUS-1</strong><br>
                    or visit any of our branch locations.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Password Recovery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>For security reasons, password reset requests must be processed by calling our customer service.</p>
                <p><strong>Please call: 1-800-NEXUS-1</strong></p>
                <p>Have your account information ready:</p>
                <ul>
                    <li>Full name as it appears on account</li>
                    <li>Account number or Social Security Number</li>
                    <li>Phone number on file</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Enrollment Modal -->
<div class="modal fade" id="enrollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Online Banking Enrollment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>To enroll in our secure online banking system, you'll need:</p>
                <ul>
                    <li>Valid Nexus Digital Bank account</li>
                    <li>Account number</li>
                    <li>Social Security Number</li>
                    <li>Valid email address</li>
                    <li>Phone number on file</li>
                </ul>
                <p>For security, enrollment must be completed by calling customer service or visiting a branch.</p>
                <p><strong>Call: 1-800-NEXUS-1</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced login form handling with 2FA support
document.getElementById('loginForm').addEventListener('submit', function(e) {
    const submitBtn = document.querySelector('button[type="submit"]');
    const isVerifyStep = submitBtn.id === 'verifyBtn';
    
    if (isVerifyStep) {
        // 2FA verification step
        const verifyText = document.getElementById('verifyText');
        const verifySpinner = document.getElementById('verifySpinner');
        
        verifyText.textContent = 'Verifying...';
        verifySpinner.style.display = 'inline-block';
        submitBtn.disabled = true;
    } else {
        // Initial login step
        const loginText = document.getElementById('loginText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        loginText.textContent = 'Signing In...';
        loadingSpinner.style.display = 'inline-block';
        submitBtn.disabled = true;
    }
});

// Auto-format 2FA code input
const twoFAInput = document.getElementById('two_fa_code');
if (twoFAInput) {
    twoFAInput.addEventListener('input', function(e) {
        // Only allow numbers
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        
        // Auto-submit when 6 digits are entered
        if (e.target.value.length === 6) {
            // Add visual feedback
            e.target.classList.add('is-valid');
            setTimeout(() => {
                document.getElementById('loginForm').submit();
            }, 500);
        } else {
            e.target.classList.remove('is-valid');
        }
    });
    
    // Focus on 2FA input when page loads
    twoFAInput.focus();
    
    // Add countdown timer for 2FA expiry
    startCountdown();
}

function clearActiveCountdown() {
    // Clear any existing countdown timer
    if (window.activeCountdownTimer) {
        clearInterval(window.activeCountdownTimer);
        window.activeCountdownTimer = null;
    }
}

function resend2FA() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
    btn.disabled = true;
    
    // Clear any existing countdown timer before starting new one
    clearActiveCountdown();
    
    // Call backend to generate new 2FA code
    fetch('/resend_2fa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show confirmation message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-mobile-alt me-2"></i>
                <strong>New verification code sent!</strong><br>
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.card-body').insertBefore(alertDiv, document.getElementById('loginForm'));
            
            // Reset countdown timer with fresh timer
            startCountdown();
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${data.error}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.card-body').insertBefore(alertDiv, document.getElementById('loginForm'));
        }
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Show generic error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> Unable to resend code. Please try again.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.card-body').insertBefore(alertDiv, document.getElementById('loginForm'));
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
    });
}

function startCountdown() {
    // Clear any existing countdown timer before starting new one
    clearActiveCountdown();
    
    let timeLeft = 300; // 5 minutes
    
    // Remove existing countdown if present
    const existingCountdown = document.getElementById('countdownElement');
    if (existingCountdown) {
        existingCountdown.remove();
    }
    
    const countdownElement = document.createElement('div');
    countdownElement.id = 'countdownElement';
    countdownElement.className = 'alert alert-light mt-3 text-center';
    countdownElement.innerHTML = `
        <i class="fas fa-clock me-2"></i>
        Code expires in: <strong id="countdown">5:00</strong>
    `;
    
    document.querySelector('.card-body').appendChild(countdownElement);
    
    // Store the timer globally so we can clear it
    window.activeCountdownTimer = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        const countdownSpan = document.getElementById('countdown');
        if (countdownSpan) {
            countdownSpan.textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        if (timeLeft <= 0) {
            clearInterval(window.activeCountdownTimer);
            window.activeCountdownTimer = null;
            countdownElement.className = 'alert alert-danger mt-3 text-center';
            countdownElement.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Code expired!</strong> Please <a href="${window.location.pathname}">login again</a>.
            `;
            
            // Disable the form
            const codeInput = document.getElementById('two_fa_code');
            const verifyBtn = document.getElementById('verifyBtn');
            if (codeInput) codeInput.disabled = true;
            if (verifyBtn) verifyBtn.disabled = true;
        } else if (timeLeft <= 60) {
            // Change to warning color when less than 1 minute
            countdownElement.className = 'alert alert-warning mt-3 text-center';
        }
    }, 1000);
}

// Lockout countdown timer
if (document.getElementById('lockoutCountdown')) {
    const lockoutTime = {{ lockout_time|default(900) }};  // Default to 15 minutes
    console.log('Lockout time from server:', lockoutTime, 'seconds');
    
    if (lockoutTime > 0) {
        startLockoutCountdown(lockoutTime);
    } else {
        // Fallback to 15 minutes if time is 0
        console.log('Lockout time was 0, using fallback of 900 seconds');
        startLockoutCountdown(900);
    }
}

function startLockoutCountdown(initialTime) {
    let timeLeft = initialTime;
    
    const countdownElement = document.getElementById('lockoutCountdown');
    const progressElement = document.getElementById('lockoutProgress');
    const buttonElement = document.getElementById('lockedBtn');
    
    const timer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        countdownElement.textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Update progress bar
        const progressPercent = (timeLeft / initialTime) * 100;
        progressElement.style.width = `${progressPercent}%`;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            countdownElement.textContent = 'Lockout Expired';
            progressElement.style.width = '0%';
            progressElement.className = 'progress-bar bg-success';
            
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-unlock me-2"></i>Try Login Again';
            buttonElement.className = 'btn btn-success w-100';
            buttonElement.onclick = () => window.location.reload();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Account Unlocked!</strong> You may now attempt to login again.
            `;
            document.querySelector('.card-body').appendChild(alertDiv);
        } else if (timeLeft <= 60) {
            // Change to warning color when less than 1 minute
            progressElement.className = 'progress-bar bg-danger';
        } else if (timeLeft <= 300) {
            // Orange for last 5 minutes
            progressElement.className = 'progress-bar bg-warning';
        }
        
        timeLeft--;
    }, 1000);
}

function refreshLockoutStatus() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    btn.disabled = true;
    
    // Simulate checking status
    setTimeout(() => {
        // Just reload the page to check current status
        window.location.reload();
    }, 2000);
}

// Add security indicators
document.addEventListener('DOMContentLoaded', function() {
    // Add SSL indicator
    const sslIndicator = document.createElement('div');
    sslIndicator.className = 'alert alert-success alert-sm mb-3';
    sslIndicator.innerHTML = `
        <i class="fas fa-lock me-2"></i>
        <small>This connection is secured with 256-bit SSL encryption</small>
    `;
    
    const cardBody = document.querySelector('.card-body');
    cardBody.insertBefore(sslIndicator, cardBody.firstChild);
});
</script>

<style>
.alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
}

#two_fa_code {
    font-family: 'Courier New', monospace;
}

.card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.countdown-warning {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
</style>
{% endblock %}
