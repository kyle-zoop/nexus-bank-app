{% extends "base.html" %}

{% block title %}Account Statements - Nexus Digital Bank Australia{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3><i class="fas fa-file-alt me-2"></i>Account Statements</h3>
                <p class="mb-0">View and download your account statements</p>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Account Holder: {{ user.name }}</h5>
                        <p class="text-muted">Select an account below to view statements</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" onclick="downloadAllStatements()">
                            <i class="fas fa-download me-1"></i>Download All Statements
                        </button>
                    </div>
                </div>
                
                <!-- Account Selection Tabs -->
                <ul class="nav nav-tabs" id="accountTabs" role="tablist">
                    {% for account_type, account in user.accounts.items() %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="{{ account_type }}-tab" data-bs-toggle="tab" 
                                data-bs-target="#{{ account_type }}-pane" type="button" 
                                role="tab" aria-controls="{{ account_type }}-pane" 
                                aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            {% if account_type == 'checking' %}
                                <i class="fas fa-university me-1"></i>
                            {% elif account_type == 'savings' %}
                                <i class="fas fa-piggy-bank me-1"></i>
                            {% elif account_type == 'credit_card' %}
                                <i class="fas fa-credit-card me-1"></i>
                            {% elif account_type == 'mortgage' %}
                                <i class="fas fa-home me-1"></i>
                            {% elif account_type == 'investment' %}
                                <i class="fas fa-chart-line me-1"></i>
                            {% elif account_type == 'auto_loan' %}
                                <i class="fas fa-car me-1"></i>
                            {% elif account_type == 'student_loan' %}
                                <i class="fas fa-graduation-cap me-1"></i>
                            {% endif %}
                            {{ account.account_type }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                
                <!-- Account Content Panes -->
                <div class="tab-content" id="accountTabsContent">
                    {% for account_type, account in user.accounts.items() %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                         id="{{ account_type }}-pane" role="tabpanel" 
                         aria-labelledby="{{ account_type }}-tab">
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Account Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Account Type:</strong> {{ account.account_type }}</p>
                                        <p><strong>Account Number:</strong> {{ account.account_number }}</p>
                                        {% if account_type == 'credit_card' %}
                                            <p class="h6">Current Balance: <span class="text-danger">{{ account.balance|abs|aud }}</span></p>
                                            <p class="small">Available Credit: <span class="text-success">{{ account.available_credit|aud }}</span></p>
                                        {% elif account_type in ['auto_loan', 'mortgage', 'student_loan'] %}
                                            <p class="h6">Remaining Balance: <span class="text-danger">{{ account.balance|abs|aud }}</span></p>
                                            <p class="small">Monthly Payment: {{ account.monthly_payment|aud }}</p>
                                        {% else %}
                                            <p class="h6">Current Balance: <span class="text-success">{{ account.balance|aud }}</span></p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transaction History -->
                        <div class="card mt-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Recent Transactions</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for transaction in account.transactions[:10] %}
                                            <tr>
                                                <td>{{ transaction.date }}</td>
                                                <td>{{ transaction.description }}</td>
                                                <td class="{% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount|aud }}
                                                </td>
                                                <td>{{ transaction.balance|aud }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {% if account.transactions|length > 10 %}
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary" onclick="toggleAllTransactions('{{ account_type }}')" id="toggle-btn-{{ account_type }}">
                                        <i class="fas fa-chevron-down me-1"></i>View All {{ account.transactions|length }} Transactions
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Extended Transaction History (Initially Hidden) -->
                            {% if account.transactions|length > 10 %}
                            <div class="collapse" id="extended-transactions-{{ account_type }}">
                                <div class="card-body pt-0">
                                    <div class="border-top pt-3">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-history me-2"></i>Complete Transaction History
                                            <small class="ms-2">({{ account.transactions|length - 10 }} additional transactions)</small>
                                        </h6>
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Description</th>
                                                        <th>Amount</th>
                                                        <th>Balance</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for transaction in account.transactions[10:] %}
                                                    <tr>
                                                        <td>{{ transaction.date }}</td>
                                                        <td>{{ transaction.description }}</td>
                                                        <td class="{% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount|aud }}
                                                        </td>
                                                        <td>{{ transaction.balance|aud }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statement Period Selection Modal -->
<div class="modal fade" id="statementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Statement Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Recent Statements</h6>
                        <div class="list-group">
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateStatement('current')">
                                <strong>Current Month</strong> (July 2025)
                                <br><small class="text-muted">July 1 - July 11, 2025</small>
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateStatement('previous')">
                                <strong>Previous Month</strong> (June 2025)
                                <br><small class="text-muted">June 1 - June 30, 2025</small>
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateStatement('may2025')">
                                <strong>May 2025</strong>
                                <br><small class="text-muted">May 1 - May 31, 2025</small>
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateStatement('apr2025')">
                                <strong>April 2025</strong>
                                <br><small class="text-muted">April 1 - April 30, 2025</small>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Custom Date Range</h6>
                        <form onsubmit="generateCustomStatement(event)">
                            <div class="mb-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="fromDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="toDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-calendar me-1"></i>Generate Statement
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentAccountType = '';

function viewStatement(accountType, period) {
    currentAccountType = accountType;
    const modal = new bootstrap.Modal(document.getElementById('statementModal'));
    modal.show();
}

function downloadStatement(accountType, format) {
    // Simulate realistic download process
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Preparing...';
    btn.disabled = true;
    
    setTimeout(() => {
        // Simulate file generation
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Ready';
        
        setTimeout(() => {
            const userName = '{{ user.name }}';
            const currentMonth = 'July_2025';
            const accountTypeName = accountType.replace('_', '_').toUpperCase();
            const fileName = `${userName.replace(/\s+/g, '_')}_${accountTypeName}_${currentMonth}.${format}`;
            
            let content, mimeType;
            
            if (format === 'pdf') {
                content = generateStatementsPDF();
                mimeType = 'application/pdf';
            } else if (format === 'csv') {
                content = generateStatementsCSV(accountType);
                mimeType = 'text/csv';
            }
            
            // Create blob and download
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }, 2000);
}

function emailStatement(accountType) {
    const email = '{{ user.email }}';
    alert(`Statement for ${accountType.replace('_', ' ')} account would be emailed to:\\n${email}\\n\\nFor security reasons, actual emails are disabled in this demo.`);
}

function downloadAllStatements() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Preparing All Statements...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Ready for Download';
        
        setTimeout(() => {
            // Generate PDF content
            const userName = '{{ user.name }}';
            const currentMonth = 'July 2025';
            const fileName = `${userName.replace(/\s+/g, '_')}_${currentMonth.replace(/\s+/g, '_')}_Statements.pdf`;
            
            // Create a simple PDF-like content (in reality this would be actual PDF generation)
            const pdfContent = generateStatementsPDF();
            
            // Create blob and download
            const blob = new Blob([pdfContent], { type: 'application/pdf' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1500);
    }, 2000);
}

function generateStatement(period) {
    alert(`Generating ${period} statement for ${currentAccountType.replace('_', ' ')} account...\\n\\nThis would normally generate a detailed PDF statement.`);
    bootstrap.Modal.getInstance(document.getElementById('statementModal')).hide();
}

function generateCustomStatement(event) {
    event.preventDefault();
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    if (new Date(fromDate) > new Date(toDate)) {
        alert('From date must be before to date.');
        return;
    }
    
    alert(`Generating custom statement for ${currentAccountType.replace('_', ' ')} account\\nFrom: ${fromDate}\\nTo: ${toDate}\\n\\nThis would normally generate a detailed PDF statement.`);
    bootstrap.Modal.getInstance(document.getElementById('statementModal')).hide();
}

function toggleAllTransactions(accountType) {
    const extendedSection = document.getElementById(`extended-transactions-${accountType}`);
    const toggleBtn = document.getElementById(`toggle-btn-${accountType}`);
    const bsCollapse = new bootstrap.Collapse(extendedSection, { toggle: false });
    
    if (extendedSection.classList.contains('show')) {
        // Currently expanded, so collapse it
        bsCollapse.hide();
        toggleBtn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>View All Transactions';
        toggleBtn.classList.remove('btn-primary');
        toggleBtn.classList.add('btn-outline-primary');
    } else {
        // Currently collapsed, so expand it
        bsCollapse.show();
        toggleBtn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Hide Additional Transactions';
        toggleBtn.classList.remove('btn-outline-primary');
        toggleBtn.classList.add('btn-primary');
        
        // Smooth scroll to the extended section after a brief delay
        setTimeout(() => {
            extendedSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 300);
    }
}

function viewAllTransactions(accountType) {
    // Legacy function - redirect to toggle function
    toggleAllTransactions(accountType);
}

function generateStatementsPDF() {
    const userName = '{{ user.name }}';
    const currentMonth = 'July 2025';
    const bankName = 'Nexus Digital Bank Australia';
    const currentDate = new Date().toLocaleDateString('en-AU');
    
    // Create a simplified PDF content as text (in a real implementation, you'd use a PDF library)
    const content = `%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj

2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj

3 0 obj
<<
/Type /Page
/Parent 2 0 R
/MediaBox [0 0 612 792]
/Contents 4 0 R
/Resources <<
/Font <<
/F1 5 0 R
>>
>>
>>
endobj

4 0 obj
<<
/Length 800
>>
stream
BT
/F1 16 Tf
50 750 Td
(${bankName}) Tj
0 -30 Td
(Account Statements - ${currentMonth}) Tj
0 -30 Td
(Account Holder: ${userName}) Tj
0 -30 Td
(Generated: ${currentDate}) Tj
0 -50 Td
/F1 12 Tf
(This document contains comprehensive statements for all accounts.) Tj
0 -20 Td
(Please review your transactions and contact us with any questions.) Tj
0 -40 Td
(Customer Service: 1800 NEXUS (1800 639 876)) Tj
0 -20 Td
(Email: support@nexusdigitalbank.com.au) Tj
0 -20 Td
(Website: www.nexusdigitalbank.com.au) Tj
0 -40 Td
(ABN: 12 345 678 901) Tj
0 -20 Td
(AFSL: 234567) Tj
0 -40 Td
(This is a computer-generated document.) Tj
0 -20 Td
(No signature is required.) Tj
ET
endstream
endobj

5 0 obj
<<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
endobj

xref
0 6
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000274 00000 n 
0000001126 00000 n 
trailer
<<
/Size 6
/Root 1 0 R
>>
startxref
1200
%%EOF`;
    
    return content;
}

function generateStatementsCSV(accountType) {
    const userName = '{{ user.name }}';
    const bankName = 'Nexus Digital Bank Australia';
    const currentDate = new Date().toLocaleDateString('en-AU');
    
    // CSV Header
    let csvContent = `Account Statement - ${bankName}\n`;
    csvContent += `Account Holder: ${userName}\n`;
    csvContent += `Account Type: ${accountType.replace('_', ' ').toUpperCase()}\n`;
    csvContent += `Generated: ${currentDate}\n`;
    csvContent += `\n`;
    csvContent += `Date,Description,Amount,Balance\n`;
    
    // Add sample transaction data (in a real app, this would come from the actual account data)
    const sampleTransactions = [
        ['2025-07-10', 'Sample Transaction 1', '+1,500.00', '12,345.67'],
        ['2025-07-09', 'Sample Transaction 2', '-85.50', '10,845.67'],
        ['2025-07-08', 'Sample Transaction 3', '+2,000.00', '10,931.17'],
        ['2025-07-07', 'Sample Transaction 4', '-125.00', '8,931.17'],
        ['2025-07-06', 'Sample Transaction 5', '-45.75', '9,056.17']
    ];
    
    sampleTransactions.forEach(transaction => {
        csvContent += `${transaction[0]},"${transaction[1]}","${transaction[2]}","${transaction[3]}"\n`;
    });
    
    csvContent += `\n`;
    csvContent += `End of Statement\n`;
    csvContent += `Customer Service: 1800 NEXUS (1800 639 876)\n`;
    csvContent += `Email: support@nexusdigitalbank.com.au\n`;
    
    return csvContent;
}

// Auto-open specific account tab if hash is present in URL
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        const tabButton = document.getElementById(hash + '-tab');
        if (tabButton) {
            const tab = new bootstrap.Tab(tabButton);
            tab.show();
        }
    }
});
</script>

<style>
.nav-tabs .nav-link {
    border-radius: 0.5rem 0.5rem 0 0;
}

.nav-tabs .nav-link.active {
    background-color: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

.tab-content {
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.5rem 0.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.list-group-item:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.collapse {
    transition: height 0.35s ease;
}

.table-sm td, .table-sm th {
    padding: 0.3rem;
    font-size: 0.9rem;
}

#extended-transactions-checking .border-top,
#extended-transactions-savings .border-top,
#extended-transactions-credit_card .border-top,
#extended-transactions-mortgage .border-top,
#extended-transactions-investment .border-top,
#extended-transactions-auto_loan .border-top,
#extended-transactions-student_loan .border-top {
    border-top: 2px solid #dee2e6 !important;
    margin-top: 1rem;
    padding-top: 1rem;
}

.text-muted h6 {
    font-weight: 600;
}

.btn-primary .fas {
    transition: transform 0.3s ease;
}

.btn[onclick*="toggleAllTransactions"] .fas {
    transition: transform 0.3s ease;
}
</style>
{% endblock %}
